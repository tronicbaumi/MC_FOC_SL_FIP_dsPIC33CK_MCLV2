// This file was generated by createCFunction.sci on 04-05-2023 23:15

// Computational function for X2C block BEMF_PLL_MCHP

#define SCILAB_SIM_FILE /* mark this file as Scilab simulation file */

/* include Scicos / Xcos headers */
#include <scicos.h>
#include <scicos_block4.h>
#include <scicos_malloc.h>
#include <scicos_free.h>
#include <Simulation_PortConversion.h>
//#define DEBUG // uncomment to enable debugging
#ifdef DEBUG
    #include <stdio.h>
#endif

/* include block implementation */
#include <BEMF_PLL_MCHP_FiP16.h>
#include <BEMF_PLL_MCHP_FiP16.c>

/* */
#define BLOCK_ERROR_INPUT_OUT_OF_DOMAIN (-1)
#define BLOCK_ERROR_SINGULARITY (-2)
#define BLOCK_ERROR_INTERNAL (-3)
#define BLOCK_ERROR_CANNOT_ALLOCATE_MEMORY (-16)

/* */
void x2c_BEMF_PLL_MCH_FiP16_C(scicos_block* block, scicos_flag flag);
static void x2c_BEMF_PLL_MCH_FiP16_C__OutputUpdate(scicos_block* block);
static void x2c_BEMF_PLL_MCH_FiP16_C__StateUpdate(scicos_block* block);
static void x2c_BEMF_PLL_MCH_FiP16_C__Initialization(scicos_block* block);
static void x2c_BEMF_PLL_MCH_FiP16_C__Ending(scicos_block* block);


void x2c_BEMF_PLL_MCH_FiP16_C(scicos_block* block, scicos_flag flag) {
    /*
     * This function will be called by Xcos
     */
    switch (flag) {
        case DerivativeState:  /* 0 */
        {
            break;
        }
        case OutputUpdate:     /* 1 */
        {
            x2c_BEMF_PLL_MCH_FiP16_C__OutputUpdate(block);
            break;
        }
        case StateUpdate:      /* 2 */
        {
            x2c_BEMF_PLL_MCH_FiP16_C__StateUpdate(block);
            break;
        }
        case OutputEventTiming: /* 3 */
        {
            break;
        }
        case Initialization:   /* 4 */
        {
            x2c_BEMF_PLL_MCH_FiP16_C__Initialization(block);
            break;
        }
        case Ending:           /* 5 */
        {
            x2c_BEMF_PLL_MCH_FiP16_C__Ending(block);
            break;
        }
        case ReInitialization: /* 6 */
        {
            break;
        }
        case ZeroCrossing:     /* 9 */
        {
           break;
        }
        default:     /* ContinousPropertiesUpdate (v5.5.x) Jacobian (v5.5.x) or Residute (v5.4.1) or something else */
        {
           break;
        }
    }
}


static void x2c_BEMF_PLL_MCH_FiP16_C__set_parameter(scicos_block* block, BEMF_PLL_MCHP_FIP16 *blockParam) {
    int *paramI;
    double *paramR;
    BEMF_PLL_MCHP_FIP16 *pTBEMF_PLL_MCHP_FiP16;
    
    /* *** */
    paramI = GetIparPtrs(block);  /* integer parameters  */
    paramR = GetRparPtrs(block);  /* real parameters     */
    pTBEMF_PLL_MCHP_FiP16 = GetWorkPtrs(block);
    blockParam->Ls = (int16)paramI[0];
    blockParam->Rs = (int16)paramI[1];
    blockParam->sfrLs = (int8)paramI[2];
    blockParam->sfrRs = (int8)paramI[3];
    blockParam->CurrentSampleFactor = (uint8)paramI[4];
    blockParam->n = (uint16)paramI[5];
    blockParam->sfrn = (uint8)paramI[6];
    blockParam->V_gain = (int16)paramI[7];
    blockParam->sfr_gain = (int8)paramI[8];
    blockParam->b0 = (int16)paramI[9];
    blockParam->sfr_b0 = (int8)paramI[10];
}


static void x2c_BEMF_PLL_MCH_FiP16_C__Initialization(scicos_block* block) {
    BEMF_PLL_MCHP_FIP16 *pTBEMF_PLL_MCHP_FiP16;
    int16 arrayStart = 0;

    /* Declaration of inports */
    double *inport_Ialpha_p;
    int16 inport_Ialpha;
    double *inport_Ibeta_p;
    int16 inport_Ibeta;
    double *inport_Valpha_p;
    int16 inport_Valpha;
    double *inport_Vbeta_p;
    int16 inport_Vbeta;
    double *inport_theta0_p;
    int16 inport_theta0;
    double *inport_Enable_p;
    bool inport_Enable;

    /* Declaration of outports */
    double *outport_theta;
    double *outport_speed;

    /* *** */
    pTBEMF_PLL_MCHP_FiP16 = scicos_malloc(sizeof(BEMF_PLL_MCHP_FIP16) + sizeof(int16)*256 + sizeof(int16)*256);
    GetWorkPtrs(block) = pTBEMF_PLL_MCHP_FiP16;
    x2c_BEMF_PLL_MCH_FiP16_C__set_parameter(block, pTBEMF_PLL_MCHP_FiP16);

    /* Assignment of inports */
    inport_Ialpha_p = GetInPortPtrs(block, 1);
    inport_Ialpha = convert_double_to_Q15(*inport_Ialpha_p);
    pTBEMF_PLL_MCHP_FiP16->Ialpha = &inport_Ialpha;
    inport_Ibeta_p = GetInPortPtrs(block, 2);
    inport_Ibeta = convert_double_to_Q15(*inport_Ibeta_p);
    pTBEMF_PLL_MCHP_FiP16->Ibeta = &inport_Ibeta;
    inport_Valpha_p = GetInPortPtrs(block, 3);
    inport_Valpha = convert_double_to_Q15(*inport_Valpha_p);
    pTBEMF_PLL_MCHP_FiP16->Valpha = &inport_Valpha;
    inport_Vbeta_p = GetInPortPtrs(block, 4);
    inport_Vbeta = convert_double_to_Q15(*inport_Vbeta_p);
    pTBEMF_PLL_MCHP_FiP16->Vbeta = &inport_Vbeta;
    inport_theta0_p = GetInPortPtrs(block, 5);
    inport_theta0 = convert_double_to_Q15(*inport_theta0_p);
    pTBEMF_PLL_MCHP_FiP16->theta0 = &inport_theta0;
    inport_Enable_p = GetInPortPtrs(block, 6);
    inport_Enable = convert_double_to_bool(*inport_Enable_p);
    pTBEMF_PLL_MCHP_FiP16->Enable = &inport_Enable;

    /* Assignment of parameter arrays */
    arrayStart = 0;
    pTBEMF_PLL_MCHP_FiP16->avg_d = (int16*)((int8*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart);
    arrayStart = arrayStart + sizeof(int16)*256;
    pTBEMF_PLL_MCHP_FiP16->avg_q = (int16*)((int8*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart);
    arrayStart = arrayStart + sizeof(int16)*256;

    /* Initialization */
    BEMF_PLL_MCHP_FiP16_Init(pTBEMF_PLL_MCHP_FiP16);

    /* Assignment of outports */
    outport_theta = GetOutPortPtrs(block, 1);
    *outport_theta = convert_Q15_to_double(pTBEMF_PLL_MCHP_FiP16->theta);
    outport_speed = GetOutPortPtrs(block, 2);
    *outport_speed = convert_Q15_to_double(pTBEMF_PLL_MCHP_FiP16->speed);

    /* Update of parameter arrays */
    arrayStart = 0;
    *((int16*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart) = *(pTBEMF_PLL_MCHP_FiP16->avg_d);
    arrayStart = arrayStart + sizeof(int16)*256;
    *((int16*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart) = *(pTBEMF_PLL_MCHP_FiP16->avg_q);
    arrayStart = arrayStart + sizeof(int16)*256;
}


static void x2c_BEMF_PLL_MCH_FiP16_C__Ending(scicos_block* block) {
    BEMF_PLL_MCHP_FIP16 *pTBEMF_PLL_MCHP_FiP16;
    pTBEMF_PLL_MCHP_FiP16 = GetWorkPtrs(block);
    scicos_free(pTBEMF_PLL_MCHP_FiP16);
}


static void x2c_BEMF_PLL_MCH_FiP16_C__StateUpdate_f(scicos_block* block) {
    BEMF_PLL_MCHP_FIP16 *pTBEMF_PLL_MCHP_FiP16;
    int16 arrayStart = 0;

    /* Declaration of inports */
    double *inport_Ialpha_p;
    int16 inport_Ialpha;
    double *inport_Ibeta_p;
    int16 inport_Ibeta;
    double *inport_Valpha_p;
    int16 inport_Valpha;
    double *inport_Vbeta_p;
    int16 inport_Vbeta;
    double *inport_theta0_p;
    int16 inport_theta0;
    double *inport_Enable_p;
    bool inport_Enable;

    /* Declaration of outports */
    double *outport_theta;
    double *outport_speed;

    /* *** */
    pTBEMF_PLL_MCHP_FiP16 = GetWorkPtrs(block);

    /* Assignment of inports */
    inport_Ialpha_p = GetInPortPtrs(block, 1);
    inport_Ialpha = convert_double_to_Q15(*inport_Ialpha_p);
    pTBEMF_PLL_MCHP_FiP16->Ialpha = &inport_Ialpha;
    inport_Ibeta_p = GetInPortPtrs(block, 2);
    inport_Ibeta = convert_double_to_Q15(*inport_Ibeta_p);
    pTBEMF_PLL_MCHP_FiP16->Ibeta = &inport_Ibeta;
    inport_Valpha_p = GetInPortPtrs(block, 3);
    inport_Valpha = convert_double_to_Q15(*inport_Valpha_p);
    pTBEMF_PLL_MCHP_FiP16->Valpha = &inport_Valpha;
    inport_Vbeta_p = GetInPortPtrs(block, 4);
    inport_Vbeta = convert_double_to_Q15(*inport_Vbeta_p);
    pTBEMF_PLL_MCHP_FiP16->Vbeta = &inport_Vbeta;
    inport_theta0_p = GetInPortPtrs(block, 5);
    inport_theta0 = convert_double_to_Q15(*inport_theta0_p);
    pTBEMF_PLL_MCHP_FiP16->theta0 = &inport_theta0;
    inport_Enable_p = GetInPortPtrs(block, 6);
    inport_Enable = convert_double_to_bool(*inport_Enable_p);
    pTBEMF_PLL_MCHP_FiP16->Enable = &inport_Enable;

    /* Assignment of parameter arrays */
    pTBEMF_PLL_MCHP_FiP16->avg_d = (int16*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart;
    arrayStart = arrayStart + sizeof(int16)*256;
    pTBEMF_PLL_MCHP_FiP16->avg_q = (int16*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart;
    arrayStart = arrayStart + sizeof(int16)*256;

    /* Update */
    BEMF_PLL_MCHP_FiP16_Update(pTBEMF_PLL_MCHP_FiP16);

    /* Assignment of outports */
    outport_theta = GetOutPortPtrs(block, 1);
    *outport_theta = convert_Q15_to_double(pTBEMF_PLL_MCHP_FiP16->theta);
    outport_speed = GetOutPortPtrs(block, 2);
    *outport_speed = convert_Q15_to_double(pTBEMF_PLL_MCHP_FiP16->speed);

    /* Update of parameter arrays */
    arrayStart = 0;
    *((int16*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart) = *(pTBEMF_PLL_MCHP_FiP16->avg_d);
    arrayStart = arrayStart + sizeof(int16)*256;
    *((int16*)(pTBEMF_PLL_MCHP_FiP16 + 1) + arrayStart) = *(pTBEMF_PLL_MCHP_FiP16->avg_q);
    arrayStart = arrayStart + sizeof(int16)*256;
}


static void x2c_BEMF_PLL_MCH_FiP16_C__StateUpdate(scicos_block* block) {
    if (GetNevIn(block) > 0) {
        /*
        * GetNevIn(block) returns -1 in case this function was called due to an internal zero-crossing.
        * GetNevIn(block)  ... activation index
        */
        x2c_BEMF_PLL_MCH_FiP16_C__StateUpdate_f(block);
    }
}


static void x2c_BEMF_PLL_MCH_FiP16_C__OutputUpdate(scicos_block* block) {
    /* Time dependency -> execute Update function and Output assignment in State Update function */
}


